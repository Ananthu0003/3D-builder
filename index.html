<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Model Viewer</title>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
      font-family: Inter, system-ui, sans-serif;
    }

    #info {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      padding: 14px 22px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      z-index: 10;
    }

    .ui-panel {
      position: absolute;
      right: 20px;
      top: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 10;
    }

    .control-group {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 14px;
      color: white;
    }

    .group-title {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.6;
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .view-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.25);
      color: white;
      padding: 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .dimensions-list {
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .dim-val {
      color: #00d2ff;
      font-family: monospace;
    }

    select {
      background: transparent;
      border: none;
      color: #00d2ff;
      cursor: pointer;
    }

    #selection-label {
      font-size: 0.8rem;
      margin-bottom: 5px;
      color: #00d2ff;
      font-weight: 500;
      display: none;
    }

    /* Toggle Switch */
    .toggle-container {
      display: flex;
      align-items: center;
      margin-top: 10px;
      font-size: 0.8rem;
    }

    .toggle-container input {
      margin-right: 8px;
    }
  </style>

  <!-- Import map -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>

<body>

  <div id="info">
    <strong>3D Model Viewer</strong><br>
    Rotate: Left | Zoom: Scroll | Pan: Right<br>
    <span style="font-size:0.8em; opacity:0.8;">Click part to Move</span>
  </div>

  <div class="ui-panel">
    <div class="control-group">
      <div class="group-title">Views</div>
      <div class="view-grid">
        <button class="btn" onclick="setView('top')">Top</button>
        <button class="btn" onclick="setView('bottom')">Bottom</button>
        <button class="btn" onclick="setView('front')">Front</button>
        <button class="btn" onclick="setView('back')">Back</button>
        <button class="btn" onclick="setView('left')">Left</button>
        <button class="btn" onclick="setView('right')">Right</button>
        <button class="btn" style="grid-column:span 3" onclick="setView('iso')">ISO</button>
      </div>
    </div>

    <div class="control-group">
      <div class="group-title">Actions</div>
      <button class="btn" style="width:100%" onclick="resetPositions()">Reset Positions</button>
    </div>

    <div class="control-group" id="dimensions-panel" style="display:none;">
      <div class="group-title">
        Measurement
        <select id="unit" onchange="updateDisplay()">
          <option value="mm">mm</option>
          <option value="cm">cm</option>
          <option value="m">m</option>
          <option value="in">in</option>
        </select>
      </div>
      <div id="selection-label">Overall Building</div>
      <div class="dimensions-list">
        X: <span class="dim-val" id="dx"></span><br>
        Y: <span class="dim-val" id="dy"></span><br>
        Z: <span class="dim-val" id="dz"></span>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { TransformControls } from 'three/addons/controls/TransformControls.js';
    import { STLLoader } from 'three/addons/loaders/STLLoader.js';

    /* CORE */
    let scene, camera, renderer, controls, transformControl;
    let modelGroup = new THREE.Group();
    let overallBoundingBox = new THREE.Box3();
    let selectedObject = null;
    let currentPartSize = new THREE.Vector3();
    let overallModelSize = new THREE.Vector3();

    // Store original positions/rotations for reset
    // Key: uuid, Value: { pos, rot }
    let originalTransforms = {};

    /* RAYCAST */
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    init();
    animate();

    /* ---------- INIT ---------- */
    function init() {
      scene = new THREE.Scene();
      scene.add(modelGroup);

      camera = new THREE.PerspectiveCamera(45, innerWidth / innerHeight, 0.1, 1000);
      camera.position.set(50, 50, 50);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(innerWidth, innerHeight);
      renderer.setPixelRatio(devicePixelRatio);
      document.body.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Transform Controls
      transformControl = new TransformControls(camera, renderer.domElement);
      transformControl.addEventListener('dragging-changed', function (event) {
        controls.enabled = !event.value;
      });
      scene.add(transformControl);

      scene.add(new THREE.AmbientLight(0xffffff, 0.6));

      const sun = new THREE.DirectionalLight(0xffffff, 1);
      sun.position.set(50, 100, 50);
      scene.add(sun);

      const fill = new THREE.DirectionalLight(0xffffff, 0.5);
      fill.position.set(-50, 50, -50);
      scene.add(fill);

      const grid = new THREE.GridHelper(100, 50);
      grid.material.opacity = 0.2;
      grid.material.transparent = true;
      scene.add(grid);

      loadAllParts();

      window.addEventListener('resize', onResize);
      window.addEventListener('click', onClick);
    }

    /* ---------- LOADING ---------- */
    async function loadAllParts() {
      const stlLoader = new STLLoader();

      try {
        const response = await fetch('output/data/geometry.json');
        const data = await response.json();

        let loadedCount = 0;

        for (const element of data.elements) {
          stlLoader.load(`output/stl/${element.id}.stl`, geo => {
            const mat = new THREE.MeshStandardMaterial({
              color: 0xcccccc,
              roughness: 0.6,
              metalness: 0.1,
              side: THREE.DoubleSide,
              transparent: true,
              opacity: 1.0
            });

            const mesh = new THREE.Mesh(geo, mat);
            // Default rotation from stl export usually needs adjustment if Y-up vs Z-up
            mesh.rotation.x = -Math.PI / 2;

            mesh.userData = {
              id: element.id,
              type: element.primitive_type
            };

            modelGroup.add(mesh);

            // Store for reset
            // We need to store AFTER adding? Actually position is 0,0,0 usually for these STL parts
            // but let's capture it anyway.
            originalTransforms[mesh.uuid] = {
              position: mesh.position.clone(),
              rotation: mesh.rotation.clone(),
              scale: mesh.scale.clone()
            };

            loadedCount++;
            if (loadedCount === data.elements.length) {
              finalizeScene();
            }
          });
        }
      } catch (err) {
        console.error('Failed to load parts', err);
      }
    }

    function finalizeScene() {
      overallBoundingBox = new THREE.Box3();
      modelGroup.traverse(obj => {
        if (obj.isMesh) {
          const box = new THREE.Box3().setFromObject(obj);
          overallBoundingBox.union(box);
        }
      });

      const center = new THREE.Vector3();
      overallBoundingBox.getCenter(center);

      // Center group on grid
      modelGroup.position.set(-center.x, -overallBoundingBox.min.y, -center.z);

      overallBoundingBox.getSize(overallModelSize);

      // Default display
      resetToOverall();
      fitCamera();
    }

    function fitCamera() {
      const max = Math.max(overallModelSize.x, overallModelSize.y, overallModelSize.z);
      const d = max * 2;
      camera.position.set(d, d, d);
      controls.target.set(0, overallModelSize.y / 2, 0);
      controls.update();
    }

    /* ---------- SELECTION ---------- */
    function onClick(event) {
      // Prevent selection if we are dragging the transform gizmo
      if (transformControl.dragging) return;
      if (event.target !== renderer.domElement) return;

      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const hits = raycaster.intersectObjects(modelGroup.children);

      if (hits.length > 0) {
        selectObject(hits[0].object);
      } else {
        deselectAll();
      }
    }

    function selectObject(obj) {
      if (selectedObject === obj) return;

      selectedObject = obj;

      // Attach Transform Controls
      transformControl.attach(obj);

      // Apply Ghost Mode and Glow
      modelGroup.traverse(child => {
        if (child.isMesh) {
          if (child === obj) {
            // Highlight selected with emissive glow
            child.material.emissive.setHex(0x00d2ff);
            child.material.emissiveIntensity = 0.5;
            child.material.opacity = 1.0;
          } else {
            // Ghost unselected parts
            child.material.emissive.setHex(0x000000);
            child.material.opacity = 0.25;
          }
        }
      });

      // Get size of this specific part
      const box = new THREE.Box3().setFromObject(obj);
      box.getSize(currentPartSize);

      // Update UI
      const label = document.getElementById('selection-label');
      label.style.display = 'block';
      label.textContent = obj.userData.id.split('_').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');

      updateDisplay(currentPartSize);
    }

    function deselectAll() {
      selectedObject = null;
      transformControl.detach();

      // Reset all materials
      modelGroup.traverse(child => {
        if (child.isMesh) {
          child.material.emissive.setHex(0x000000);
          child.material.emissiveIntensity = 0;
          child.material.opacity = 1.0;
        }
      });

      resetToOverall();
    }

    function resetToOverall() {
      const label = document.getElementById('selection-label');
      label.style.display = 'block';
      label.textContent = 'Overall Building';
      updateDisplay(overallModelSize);
    }

    // Global function for buttons
    window.resetPositions = function () {
      modelGroup.traverse(child => {
        if (child.isMesh && originalTransforms[child.uuid]) {
          const og = originalTransforms[child.uuid];
          child.position.copy(og.position);
          child.rotation.copy(og.rotation);
          child.scale.copy(og.scale);
        }
      });
      // Also detach if anything was selected to act clean
      deselectAll();
    }

    /* ---------- UI & MEASURE ---------- */
    window.updateDisplay = function (size) {
      if (!size) size = selectedObject ? currentPartSize : overallModelSize;

      const unitEl = document.getElementById('unit');
      if (!unitEl) return;
      const u = unitEl.value;
      const f = u === 'cm' ? 0.1 : u === 'm' ? 0.001 : u === 'in' ? 0.03937 : 1;

      document.getElementById('dx').textContent = (size.x * f).toFixed(2) + ' ' + u;
      document.getElementById('dy').textContent = (size.z * f).toFixed(2) + ' ' + u;
      document.getElementById('dz').textContent = (size.y * f).toFixed(2) + ' ' + u;

      document.getElementById('dimensions-panel').style.display = 'block';
    }

    /* ---------- VIEW ---------- */
    window.setView = function (v) {
      const d = Math.max(overallModelSize.x, overallModelSize.y, overallModelSize.z) * 2.5;
      const y = overallModelSize.y / 2;

      const positions = {
        top: [0, d, 0], bottom: [0, -d, 0],
        front: [0, 0, d], back: [0, 0, -d],
        left: [-d, 0, 0], right: [d, 0, 0],
        iso: [d, d, d]
      };

      const p = positions[v];
      if (p) {
        camera.position.set(...p);
        camera.lookAt(0, y, 0);
        controls.target.set(0, y, 0);
      }
    }

    /* ---------- MISC ---------- */
    function onResize() {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
  </script>

</body>

</html>